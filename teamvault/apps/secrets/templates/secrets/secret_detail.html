{% extends "base.html" %}
{% load humanize %}
{% load i18n %}
{% load static %}
{% block title %}{{ secret.name }}{% endblock %}
{% block content %}
    <script type="text/javascript">
        let reveal_placeholder = "{{ placeholder }}";
        let reveal_toggled = false;

        let ccCodeClipboard;
        let ccPasswordClipboard

        // TODO: Fix CC cards
        function getCC() {
            /*
            if (reveal_toggled == true) {
                $('#revealButton span').text("{% trans "Reveal" %}");
                $('#revealButton i').removeClass('fa-shield');
                $('#revealButton i').addClass('fa-magic');
                $('.jp-card-number').html("•••• •••• •••• ••••");
                $('.jp-card-name').html("•••••• ••••••");
                $('.jp-card-expiry').html("••/••••");
                $('#id_security_code').val("");
                $('#id_password').val("");
                $('#copy-ccCode').prop("disabled", true);
                $('#copy-ccPassword').prop("disabled", true);
                reveal_toggled = false;

                ccCodeClipboard.destroy();
                ccPasswordClipboard.destroy();
            } else {
                var data = getSecretSync();
                $('#revealButton span').text("{% trans "Hide" %}");
                $('#revealButton i').removeClass('fa-magic');
                $('#revealButton i').addClass('fa-shield');
                $('.jp-card-number').html(data['number']);
                $('.jp-card-name').html(data['holder']);
                $('.jp-card-expiry').html(data['expiration_month'] + "/" + data['expiration_year']);
                $('#id_security_code').val(data['security_code']);
                $('#id_password').val(data['password']);
                $('#copy-ccCode').prop("disabled", false);
                $('#copy-ccPassword').prop("disabled", false);

                ccCodeClipboard = new Clipboard("#copy-ccCode");
                ccCodeClipboard.on('success', function (e) {
                    $(".tickermessage-code").slideDown("fast").delay(2000).slideUp("slow");
                });

                ccPasswordClipboard = new Clipboard("#copy-ccPassword");
                ccPasswordClipboard.on('success', function (e) {
                    $(".tickermessage-password").slideDown("fast").delay(2000).slideUp("slow");
                });

                reveal_toggled = true;
            }
            $('.jp-card-number').change();
            $('.jp-card-name').change();
            $('.jp-card-expiry').change();
            $('#id_security_code').change();
            $('#id_password').change();
            */
        }

        function getSecret(callback) {
            $.ajax({
                url: "{{ secret_url }}",
                type: "get",
                dataType: "json",
                success: function (data) {
                    callback(data['password']);
                },
            });
        }

        function getSecretSync() {
            let secret;
            $.ajax({
                url: "{{ secret_url }}",
                async: false,
                type: "get",
                dataType: "json",
                success: function (data) {
                    secret = data;
                },
            });
            return secret;
        }

        function largeType(password) {
            // TODO: FIX bigtext
            $('.large-type').removeClass('hidden');
            $('.large-type').html("<div>" + password + "</div>");
            $('.large-type').bigtext();
            $('.large-type').mousedown(function () {
                $('.large-type').addClass('hidden');
                $('.large-type').html("");
            });
        }

        function reveal(password) {
            let revBtnTooltip = bootstrap.Tooltip.getInstance('#revealButton')
            revBtnTooltip.setContent({'.tooltip-inner': '{% trans "Hide plain text" %}'})

            const revBtn = document.getElementById('revealButton')
            revBtn.setAttribute('onclick', 'unreveal()')
            revBtn.querySelector('i').classList.remove('fa-magic')
            revBtn.querySelector('i').classList.add('fa-shield')

            let passwordField = document.getElementById('passwordField')
            passwordField.value = password
            passwordField.disabled = false
        }

        function unreveal() {
            let revBtnTooltip = bootstrap.Tooltip.getInstance('#revealButton')
            revBtnTooltip.setContent({'.tooltip-inner': '{% trans "Reveal as plain text" %}'})

            const revBtn = document.getElementById('revealButton')
            revBtn.setAttribute('onclick', 'getSecret(reveal)');
            revBtn.querySelector('i').classList.remove('fa-shield')
            revBtn.querySelector('i').classList.add('fa-magic')

            let passwordField = document.getElementById('passwordField')
            passwordField.value = reveal_placeholder
            passwordField.disabled = true
        }
    </script>
    <div class="large-type invisible"></div>

    <div class="container">
        <!-- TODO: Fix messages -->
        <!-- <div class="row">
		<div class="col-md-12">
			<div class="tickermessage tickermessage-password info d-none">
				{% trans "Password has been copied to your clipboard." %}
			</div>
			<div class="tickermessage tickermessage-username info d-none">
				{% trans "Username has been copied to your clipboard." %}
			</div>
			<div class="tickermessage tickermessage-url info d-none">
				{% trans "URL has been copied to your clipboard." %}
			</div>
			<div class="tickermessage tickermessage-code info d-none">
				{% trans "Code has been copied to your clipboard." %}
			</div>
		</div>
	</div> -->

        <!-- Secret header -->
        <div class="row">
            <div class="col-md-12">
                <h1 class="pull-left">
                    {{ secret.name }}
                </h1>
                <h1 class="pull-right secret-icons">
                    {% if secret.status == secret.STATUS_DELETED %}
                        <span data-bs-toggle="tooltip" data-bs-placement="bottom"
                              title="{% trans "This secret has been deleted and is not visible to regular users." %}"
                              class="text-danger-bright"><i class="fa fa-trash"></i></span>
                        <span class="text-muted-bright">|</span>
                    {% elif secret.status == secret.STATUS_NEEDS_CHANGING %}
                        <span data-bs-toggle="tooltip" data-bs-placement="bottom"
                              title="{% trans "This secret must be changed for security reasons. Please do so now." %}"
                              class="text-danger-bright"><i class="fa fa-refresh"></i>
                        </span>
                        <span class="text-muted-bright">|</span>
                    {% endif %}
                    {% if readable %}
                        <span data-bs-toggle="tooltip" data-bs-placement="bottom"
                              title="{% trans "You have access to this secret." %}" class="text-success-bright">
                            <i class="fa fa-unlock"></i>
                        </span>
                    {% else %}
                        <span data-bs-toggle="tooltip" data-bs-placement="bottom"
                              title="{% trans "You don't have access to this secret." %}" class="text-danger-bright">
                            <i class="fa fa-lock"></i>
                        </span>
                    {% endif %}
                </h1>
            </div>
        </div>

        <!-- Secret data -->
        <div class="row">
            <div class="col-md-8 secret-main">
                {% if readable %}
                    {% if content_type == "file" %}
                        <div class="input-group input-group-lg">
                            <input type="text" class="form-control" readonly autocomplete="off"
                                   placeholder="{{ secret.filename }}">
                            <span class="input-group-btn">
                                <a href="{% url "secrets.secret-download" secret.hashid %}" class="btn btn-default">
                                    <i class="fa fa-download"></i> &nbsp;{% trans "Download" %} &nbsp;
                                </a>
                            </span>
                        </div>
                    {% elif content_type == "password" %}
                        <div class="input-group input-group-lg">
                            <input type="text" id="passwordField" class="form-control" value="{{ placeholder }}"
                                   autocomplete="off" disabled>
                            <span class="input-group-btn">
                                <button class="btn btn-default" id="copy-password" type="button"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top" title="{% trans "Copy to clipboard" %}">
                                    <i class="fa fa-clipboard"></i>
                                </button>
                                <button id="revealButton" class="btn btn-default" type="button"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top" title="{% trans "Reveal as plain text" %}"
                                        onclick="getSecret(reveal)">
                                    <i class="fa fa-magic"></i>
                                </button>
                                <button class="btn btn-default" type="button" data-bs-toggle="tooltip"
                                        data-bs-placement="top"
                                        title="{% trans "Show in large type" %}" onclick="getSecret(largeType);">
                                    <i class="fa fa-font"></i>
                                </button>
				            </span>
                        </div>
                    {% elif content_type == "cc" %}
                        {% include 'secrets/_secret_cc_detail.html' %}
                    {% endif %}
                {% else %}
                    <div class="alert alert-danger">
                        {% trans "You do not have access to this secret." %}
                    </div>
                {% endif %}
                <hr>
                <div class="secret-attributes">
                    <table class="table-responsive">
                        {% if secret.url %}
                            <tr>
                                <td>{% trans "URL" %}</td>
                                <td>
                                    <a id="secret-url" href="{{ secret.url }}">{{ secret.url }}</a>
                                    &nbsp;
                                    <button class="btn btn-default btn-xs" id="copy-url"
                                            data-clipboard-target="#secret-url"><i class="fa fa-clipboard"></i></button>
                                </td>
                            </tr>
                        {% endif %}
                        {% if secret.username %}
                            <tr>
                                <td>{% trans "Username" %}</td>
                                <td>
                                    <span id="secret-username">{{ secret.username }}</span>
                                    &nbsp;
                                    <button class="btn btn-default btn-xs" id="copy-username"
                                            data-clipboard-target="#secret-username"><i class="fa fa-clipboard"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endif %}
                        {% if secret.description %}
                            <tr>
                                <td>{% trans "Description" %}</td>
                                <td>{{ secret.description|linebreaksbr|urlize }}</td>
                            </tr>
                        {% endif %}
                    </table>
                </div>
                <hr>
                {% if readable %}
                    <div class="btn-group btn-group-justified">
                        <div class="btn-group">
                            <a class="btn btn-default btn-lg" href="{% url "secrets.secret-edit" secret.hashid %}"><i
                                    class="fa fa-pencil"></i>&nbsp; {% trans "Edit" %}</a>
                        </div>
                        <div class="btn-group">
                            {% if secret.status == secret.STATUS_DELETED %}
                                <a class="btn btn-default btn-lg"
                                   href="{% url "secrets.secret-restore" secret.hashid %}"
                                   title="{% trans "Undelete this secret" %}"><i
                                        class="fa fa-undo"></i>&nbsp; {% trans "Restore" %}</a>
                            {% else %}
                                <a class="btn btn-default btn-lg"
                                   href="{% url "secrets.secret-delete" secret.hashid %}"><i class="fa fa-trash"></i>&nbsp; {% trans "Delete" %}
                                </a>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="col-md-3 col-md-offset-1 secret-meta">
                <table>
                    <tr>
                        <td>{% trans "Changed" %}</td>
                        <td><span data-bs-toggle="tooltip" data-bs-placement="top"
                                  title="{{ secret.last_changed|date:"Y-m-d H:i:s e" }}">{{ secret.last_changed|naturalday:"Y-m-d" }}</span>
                        </td>
                    </tr>
                    <tr>
                        <td>{% trans "Changed by" %}</td>
                        <td>{{ secret.current_revision.set_by.username }}</td>
                    </tr>
                    <tr>
                        <td class="separator"></td>
                        <td class="separator"></td>
                    </tr>
                    <tr>
                        <td>{% trans "Created" %}</td>
                        <td><span data-bs-toggle="tooltip" data-bs-placement="top"
                                  title="{{ secret.created|date:"Y-m-d H:i:s e" }}">{{ secret.created|naturalday:"Y-m-d" }}</span>
                        </td>
                    </tr>
                    <tr>
                        <td>{% trans "Created by" %}</td>
                        <td>{{ secret.created_by.username }}</td>
                    </tr>
                    <tr>
                        <td class="separator"></td>
                        <td class="separator"></td>
                    </tr>
                    <tr>
                        <td>{% trans "Allowed" %}</td>
                        <td>
						<span data-bs-toggle="tooltip" data-bs-placement="left"
                              title="{% for group in secret.allowed_groups.all %}{{ group.name }}<br>{% endfor %}">
							{% blocktrans with groupcount=secret.allowed_groups.all|length %}
                                {{ groupcount }} group(s)
                            {% endblocktrans %}
						</span><br>
                            <span data-bs-toggle="tooltip" data-bs-placement="left"
                                  title="{% for user in secret.allowed_users.all %}{{ user.username }}<br>{% endfor %}">
							{% blocktrans with usercount=secret.allowed_users.all|length %}
                                {{ usercount }} user(s)
                            {% endblocktrans %}
						</span>
                        </td>
                    </tr>
                    {% if request.user.is_superuser %}
                        <tr>
                            <td class="separator"></td>
                            <td class="separator"></td>
                        </tr>
                        <tr>
                            <td>
                                <i class="fa fa-address-card-o" aria-hidden="true"></i> &nbsp;
                                <a href="{% url 'audit.log' %}?secret={{ secret.hashid }}">{% trans "Audit log" %}</a>
                            </td>
                        </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            // $(".tickermessage").hide();

            {% if content_type == "password" %}
                /*
                var passwordClipboard = new Clipboard("#copy-password", {
                    text: function (trigger) {
                        return getSecretSync()['password'];
                    }
                });
                passwordClipboard.on('success', function (e) {
                    $(".tickermessage-password").slideDown("fast").delay(2000).slideUp("slow");
                });

                var urlClipboard = new Clipboard("#copy-url");
                urlClipboard.on('success', function (e) {
                    $(".tickermessage-url").slideDown("fast").delay(2000).slideUp("slow");
                });

                var usernameClipboard = new Clipboard("#copy-username");
                usernameClipboard.on('success', function (e) {
                    $(".tickermessage-username").slideDown("fast").delay(2000).slideUp("slow");
                });
                */
            {% endif %}

            {% if content_type == 'cc' %}
                $('#copy-ccCode').prop("disabled", true);
                $('#copy-ccPassword').prop("disabled", true);

                $('#ccform').card({
                    container: '.card-wrapper',
                    numberInput: 'input#id_number',
                    expiryInput: 'input#id_expiration_month, input#id_expiration_year',
                    cvcInput: 'input#id_security_code',
                    nameInput: 'input#id_holder',
                    messages: {
                        validDate: '{% trans "valid\nthru" %}',
                        monthYear: '{% trans "MM" %}/{% trans "YYYY" %}',
                    },
                    values: {
                        number: '•••• •••• •••• ••••',
                        name: '•••••• ••••••',
                        expiry: '••/••••',
                        cvc: '•••'
                    }
                });
            {% endif %}
        });
    </script>
    <script src="{% static 'bundled/bigtext/dist/bigtext.js' %}"></script>
{% endblock %}
